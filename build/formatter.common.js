"use strict";const utils=loadModule("core.utils"),mdn=utils.loadMDN();function format(e,t=!1,s,o){const r=utils.getPathAsObject(mdn,e);if(!r.__compat&&!utils.hasChildren(r))return err(utils.breakAnsiLine(`?y${text.notFeatureObject}?R`,options.maxChars)),process.exitCode=1,null;const n=utils.getBrowserList();if(options.columns){const e=options.columns.split(/[ ,;:]/g),s=Object.keys(utils.getBrowserNames()),o=e.filter(e=>s.includes(e));if(o.length&&o.length===e.length)n.desktop=n.desktop.filter(e=>o.includes(e)),n.mobile=n.mobile.filter(e=>o.includes(e)),n.ext=n.ext.filter(e=>o.includes(e)),options.ext=n.ext.length>0;else if(!t)return err(`\n?y${text.invalidColumnIds}?R`),process.exitCode=1,null}const i=/<a\s+(?:[^>]*?\s+)?href=(["'])(.*?)\1/gi,l=r.__compat||{},a=l.support||{},p=l.status||{},d=l.specs||[],u=e.startsWith("webextensions"),c=e.startsWith("javascript"),h="object"==typeof r.worker_support&&"object"==typeof r.worker_support.__compat,f="object"==typeof r.new_required,m="object"==typeof r.sharedarraybuffer_support,x="object"==typeof r.svg_support,_="object"==typeof r.textarea_support;let b=l.title||l.short?(l.title||l.short).replace("â†’","-&gt;"):null;const g=l.mdn_url&&l.mdn_url.length?("https://developer.mozilla.org/docs/"+l.mdn_url).replace(".org/docs/Mozilla/Add-ons/",".org/Add-ons/"):null,y={isCompat:"object"==typeof r.__compat,support:{newRequired:f,inWorker:h,sabAsBuffer:m,inSVG:x,inTextArea:_,any:f||h||m||x||_},path:e,prePath:utils.prePathFromPath(mdn,e),name:utils.nameFromPath(e),title:b,description:l.description||"",url:g,specs:d,experimental:p.experimental,standard:p.standard_track||t&&u,deprecated:p.deprecated,browsers:{desktop:[],mobile:[],ext:[]},notes:[],links:[],children:[],isFiltered:!1};if(options.desktop&&n.desktop.length&&n.desktop.forEach(e=>{y.browsers.desktop.push(k(e,a))}),options.mobile&&n.mobile.length&&n.mobile.forEach(e=>{y.browsers.mobile.push(k(e,a))}),options.ext&&n.ext.length&&n.ext.filter(e=>!!c||"nodejs"!==e).forEach(e=>{y.browsers.ext.push(k(e,a))}),options.children&&!t){const t=options.args.length?options.args.map(e=>utils.getComparer(e,!(e.includes("*")||e.startsWith("/")),!0)):null;y.isFiltered=!!t;const s=options.history;options.history=!1,Object.keys(r).forEach(s=>{const o=r[s].__compat;if(o){const r=o.status||{};if(options.obsolete||u||(r.experimental||r.standard_track||r.deprecated)&&!r.deprecated){const o=e+"."+s;t&&!function(e,t){for(let s of t)if(s.test(e))return!0}(s,t)||y.children.push(format(o,!0,y.notes,y.links))}}}),options.history=s}function k(e,t){const r=[],n=[],l=t[e]||{};let a=Array.isArray(l)?l:[l];options.history||(a=[a[0]]);const p=s||y.notes,d=o||y.links;return a.forEach(e=>{const t=[];if(options.notes&&(e.notes||e.prefix||e.alternative_name||e.partial_implementation)){const s=Array.isArray(e.notes)?e.notes:e.notes?[e.notes]:[];if(e.prefix&&s.push(text.vendorPrefix+": "+e.prefix),e.alternative_name){let t=utils.ansiFree(utils.versionAddRem(e.version_added,e.version_removed));t=t===char.yes?"":t+" ",s.push(text.versionColumn+t+text.usesAltName+": ?w"+e.alternative_name+"?R")}e.partial_implementation&&s.push(text.partialImpl),s.forEach(e=>{let s=function(e,t){for(let s=0;s<t.length;s++)if(t[s].note===e)return t[s].index;return-1}(e,p);s<0&&(s=p.length,p.push({index:s,note:e}),e.replace(i,(e,t,o)=>{d.push({index:s,url:o})})),n.includes(s)||n.push(s),t.includes(s)||t.push(s)})}(options.history||!options.history&&!r.length)&&r.push(Object.assign(e,{version_removed:e.version_removed||null===e.version_added&&null,flags:e.flags||[],notes:t}))}),{browser:e,history:r,noteIndex:n.sort()}}return function(){let e=-1,t=-1;y.links.forEach(s=>{s.index!==t&&(t=s.index,e++),s.linkIndex=e})}(),y}module.exports=format;