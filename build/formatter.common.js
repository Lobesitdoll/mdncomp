"use strict";const utils=loadModule("core.utils"),mdn=utils.loadMDN();function format(t,e=!1,s,n){const o=utils.getPathAsObject(mdn,t);if(!o.__compat&&!utils.hasChildren(o))return err(utils.breakAnsiLine(`?y${text.notFeatureObject}?R`,options.maxChars)),process.exitCode=1,null;const i=utils.getBrowserList();if(options.columns){const t=options.columns.split(/[ ,;:]/g),s=Object.keys(utils.getBrowserNames()),n=t.filter(t=>s.includes(t));if(n.length&&n.length===t.length)i.desktop=i.desktop.filter(t=>n.includes(t)),i.mobile=i.mobile.filter(t=>n.includes(t)),i.ext=i.ext.filter(t=>n.includes(t)),options.ext=i.ext.length>0;else if(!e)return err(`\n?y${text.invalidColumnIds}?R`),process.exitCode=1,null}const r=/<a\s+(?:[^>]*?\s+)?href=(["'])(.*?)\1/gi,l=o.__compat||{},a=l.support||{},p=l.status||{},d=t.startsWith("webextensions"),c=t.startsWith("javascript"),u=l.mdn_url&&l.mdn_url.length?utils.uncompactURL(l.mdn_url):null;let h=l.title?l.title.replace("â†’",char.arrowRight):null;const m={isCompat:"object"==typeof o.__compat,path:t,prePath:utils.prePathFromPath(mdn,t),name:utils.nameFromPath(t),title:h,mdntitle:l.mdn_title,description:l.description,url:u,specs:l.specs||l.spec_urls||[],experimental:p.experimental,standard:p.standard_track||e&&d,deprecated:p.deprecated,browsers:{desktop:[],mobile:[],ext:[]},notes:[],links:[],children:[],isFiltered:!1};if(options.desktop&&i.desktop.length&&i.desktop.forEach(t=>{m.browsers.desktop.push(f(t,a))}),options.mobile&&i.mobile.length&&i.mobile.forEach(t=>{m.browsers.mobile.push(f(t,a))}),options.ext&&i.ext.length&&i.ext.filter(t=>(c||"nodejs"!==t)&&(d||"thunderbird"!==t)).forEach(t=>{m.browsers.ext.push(f(t,a))}),options.children&&!e){const e=options.args.length?options.args.map(t=>utils.getComparer(t,!(t.includes("*")||t.startsWith("/")),!0)):null;m.isFiltered=!!e;const s=options.history;options.history=!1,Object.keys(o).forEach(s=>{const n=o[s].__compat;if(n){const o=n.status||{};if(options.obsolete||d||(o.experimental||o.standard_track||o.deprecated)&&!o.deprecated){const n=t+"."+s;e&&!utils.testFilters(e,s)||m.children.push(format(n,!0,m.notes,m.links))}}}),options.history=s}function f(t,e){const o=[],i=[],l=e[t]||{};let a=Array.isArray(l)?l:[l];options.history||(a=[a[0]]);const p=s||m.notes,d=n||m.links;return a.forEach(t=>{const e=[];if(options.notes&&(t.notes||t.prefix||t.alternative_name||t.partial_implementation)){const s=Array.isArray(t.notes)?t.notes:t.notes?[t.notes]:[];if(t.prefix&&s.push(text.vendorPrefix+": "+t.prefix),t.alternative_name){let e=utils.ansiFree(utils.versionAddRem(t.version_added,t.version_removed));e=e===char.yes?"":e+" ",s.push(`${text.versionColumn} ${e}${text.usesAltName}: ?w${t.alternative_name}?R`)}t.partial_implementation&&s.push(text.partialImpl),s.forEach(t=>{let s=function(t,e){for(let s=0;s<e.length;s++)if(e[s].note===t)return e[s].index;return-1}(t,p);s<0&&(s=p.length,p.push({index:s,note:t}),t.replace(r,(t,e,n)=>{d.push({index:s,url:n})})),i.includes(s)||i.push(s),e.includes(s)||e.push(s)})}(options.history||!options.history&&!o.length)&&o.push(Object.assign(t,{version_removed:t.version_removed||null===t.version_added&&null,flags:t.flags||[],notes:e}))}),{browser:t,history:o,noteIndex:i.sort()}}return function(){let t=-1,e=-1;m.links.forEach(s=>{s.index!==e&&(e=s.index,t++),s.linkIndex=t})}(),m.children.sort((t,e)=>{const s=t.title||t.name,n=e.title||e.name;return s>n?1:s<n?-1:0}),m}module.exports=format;