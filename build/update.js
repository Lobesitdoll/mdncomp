const io=require("./io"),ANSI=require("./ansi"),fs=require("fs"),path=require("path"),log=console.log.bind(console),urlPrefix="https://raw.githubusercontent.com/epistemex/data-for-mdncomp/master/";function buildTable(e){const r=[];return listTopLevels(e).forEach(t=>{"browsers"!==t&&function e(t,o,a){const n=t[o];"object"==typeof n&&Object.keys(n).forEach(t=>{"__compat"!==t&&(r.push(a+"."+t),e(n,t,a+"."+t))})}(e,t,t)}),r}function listTopLevels(e){let r=Object.keys(e),t=r.indexOf("browsers");return t>=0&&r.splice(t,1),r}function serverMD5(e){io.request(urlPrefix+"data2.md5",null,null,e,e=>{log("An error occurred:",e.statusCode,e.error)})}function getCachedMD5(e,r){try{return fs.readFileSync(e)+""}catch(e){return calcFileMD5(r)}}function calcFileMD5(e){try{return calcMD5(fs.readFileSync(e))+""}catch(e){return""}}function calcMD5(e){return require("crypto").createHash("md5").update(e).digest("hex")+""}module.exports=function(e,r,t){const o=ANSI.clrToCursor+ANSI.cursorUp,a=path.normalize(path.dirname(process.mainModule.filename)+"/../data/data."),n=a+"json",l=a+"md5";function c(){io.request(urlPrefix+"data2.json",()=>!i(),e=>{let r=Math.round(50*e),t=50-r;log(o+ANSI.white+"Downloading data "+ANSI.white+"["+ANSI.green+"#".repeat(r)+" ".repeat(t)+ANSI.white+"]"+ANSI.reset+ANSI.black)},e=>{let r=t?function(e){let r;try{let t=buildTable(require("../data/data.json")),o=buildTable(JSON.parse(e)),a=[];o.forEach(e=>{t.includes(e)||a.push(e)}),r=`--diff-- New features (${a.length}):\n`+a.join("\n")}catch(e){r=ANSI.red+"Could not perform diff:\n"+e.message+ANSI.reset}return r}(e):"";io.writeAll([{path:n,data:e},{path:l,data:calcMD5(e)}],(t,a)=>{a?t.forEach(e=>{e.err&&s("An error occurred writing data to file. Please retry: "+lf+e.path+": "+e.err+ANSI.reset)}):log(o+ANSI.white+("Updated with "+e.length+" bytes. All systems are GO!").padEnd(72," ")+ANSI.reset),r.length&&log(r)})},e=>s(lf+"An error occurred -"+lf+"Status code: "+e.statusCode+(e.error?lf+"Message: "+e.error:"")+ANSI.reset))}function i(){log(o+"".padStart(72," "))}function s(e){log(o+ANSI.red+e+ANSI.white)}log("Connecting..."),e?c():serverMD5(e=>{let t=getCachedMD5(l,n);i(),log(o+ANSI.white+(e===t?"No change in data - cancelling (or use the --fupdate option).":"Update is available ("+e+").")),r||e===t||c()})};