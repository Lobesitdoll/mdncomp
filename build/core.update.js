const fs=require("fs"),Path=require("path"),zlib=require("zlib"),io=loadModule("core.io"),filePrefix=Path.join(__dirname,"../data")+Path.sep,urlPrefix="https://raw.githubusercontent.com/epistemex/mdncomp-data/master/",urlPrefixR="https://gitlab.com/epistemex/mdncomp-data/raw/master/",clr=ANSI.clrToCursor+ANSI.cursorUp,PWIDTH=40;let wasRedundant=!1;function clrLine(){log(clr+"".padStart(options.maxChars," "))}function compareMD5(e,t){const r=t||wasRedundant?urlPrefixR:urlPrefix;let a;try{a=fs.readFileSync(filePrefix+filenameMD5,"utf-8")}catch(e){err(e)}io.request(r+"data.md5",null,null,t=>{e({local:a,remote:t})},r=>{wasRedundant=!0,t?err(`?r${text.error}:?R`,r.statusCode,r.error):(log(`?y${text.tryingRedundancy}...?R\n`),setImmediate(compareMD5,e,!0))})}function getRemoteData(e,t){const r=t||wasRedundant?urlPrefixR:urlPrefix;let a,n,i=0;function o(){log(`${clr}?w${text.downloadingData} [?b${char.progressBar.repeat(n)+" ".repeat(PWIDTH-n)}?w]?R`)}io.request(r+"data.gz",()=>!clrLine(),e=>{n=Math.ceil(PWIDTH*e),(a=Date.now())-i>250&&(i=a,o())},t=>{o(),e(null,zlib.gunzipSync(t))},r=>{wasRedundant=!0,t?e(r):(err(`?${text.tryingRedundancy}...?R\n`),setImmediate(getRemoteData,e,!0))},!0)}function update(e){const t=`?g${text.noNewData}.?R\n`;log(),compareMD5(r=>{function a(){getRemoteData((e,t)=>{e?err(e):function(e,t){try{fs.writeFileSync(filePrefix+filenameData,e,"utf-8"),fs.writeFileSync(filePrefix+filenameMD5,t,"utf-8")}catch(e){err(e)}clrLine(),log(`?g${text.dataUpdated}!?R`)}(t,r.remote)})}e?a():r.local===r.remote?log(t):a()})}module.exports=update;