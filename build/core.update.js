const fs=require("fs"),Path=require("path"),zlib=require("zlib"),rfc6902=require("rfc6902"),io=loadModule("core.io"),filePrefix=Path.join(__dirname,"../data")+Path.sep,urlPrefix="https://raw.githubusercontent.com/epistemex/mdncomp-data/master/",urlPrefixR="https://gitlab.com/epistemex/mdncomp-data/raw/master/",clr=ANSI.clrToCursor+ANSI.cursorUp,PWIDTH=40;let wasRedundant=!1;function clrLine(){log(clr+"".padStart(options.maxChars," "))}function compareMD5(e,t){const a=t||wasRedundant?urlPrefixR:urlPrefix;let r;try{r=fs.readFileSync(filePrefix+"data.md5","utf-8")}catch(e){e(e)}io.request(a+"data.md5",null,null,t=>{e({local:r,remote:t})},a=>{wasRedundant=!0,t?a(`?r${text.error}:?R`,a.statusCode,a.error):(log(`?y${text.tryingRedundancy}...?R\n`),setImmediate(compareMD5,e,!0))})}function getPatch(e,t){let a=urlPrefix+"patches/"+e.remote+"_"+e.local;io.request(a,null,null,e=>{t(null,zlib.gunzipSync(e))},e=>t(e),!0)}function getRemoteData(e,t){const a=t||wasRedundant?urlPrefixR:urlPrefix;let r,n,l=0;function o(){log(`${clr}?w${text.downloadingData} [?b${char.progressBar.repeat(n)+" ".repeat(PWIDTH-n)}?w]?R`)}io.request(a+"data.gz",()=>!clrLine(),e=>{n=Math.ceil(PWIDTH*e),(r=Date.now())-l>250&&(l=r,o())},t=>{o(),e(null,zlib.gunzipSync(t))},a=>{wasRedundant=!0,t?e(a):(log(`?${text.tryingRedundancy}...?R\n`),setImmediate(getRemoteData,e,!0))},!0)}function getCurrentData(){let e={};try{e=JSON.parse(fs.readFileSync(filePrefix+"data.json","utf-8"))}catch(e){}return e}function update(e){const t=`?g${text.noNewData}.?R\n`;log(),compareMD5(a=>{function r(){getRemoteData((e,t)=>{e?err(e):n(t,a.remote)})}function n(e,t){try{fs.writeFileSync(filePrefix+"data.json",e,"utf-8"),fs.writeFileSync(filePrefix+"data.md5",t,"utf-8")}catch(e){err(e)}clrLine(),log(`?g${text.dataUpdated}!?R`)}e?r():a.local===a.remote?log(t):getPatch(a,(e,t)=>{if(e)log(`?y${text.noPatchAvailable} - ${text.downloadingFullData}...?R`),r();else{let l=getCurrentData(),o=!1;log(text.applyingPatch+lf);let i=JSON.parse(t);rfc6902.applyPatch(l,i).forEach(e=>{e&&(e(`?r${text.error}: "${e.name}": ${e.message}?R`),o=!0)}),o?(e(`?r${text.errorDuringPatching} ${a.local} -> ${a.remote}.?y${lf}${text.downloadingFullData}...?R`),r()):(!function(e){let t=0,a=0,r=0;e.forEach(e=>{"add"===e.op?t++:"remove"===e.op?a++:"replace"===e.op&&r++}),log(`?R${text.diffSummary}: ${t} ${text.adds}, ${r} ${text.updates}, ${a} ${text.removes}\n`)}(i),n(JSON.stringify(l),a.remote))}})})}module.exports=update;